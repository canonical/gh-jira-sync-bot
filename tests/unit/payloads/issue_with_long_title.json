{
  "action": "labeled",
  "issue": {
    "url": "https://api.github.com/repos/beliaev-maksim/test-ci/issues/30",
    "repository_url": "https://api.github.com/repos/beliaev-maksim/test-ci",
    "labels_url": "https://api.github.com/repos/beliaev-maksim/test-ci/issues/30/labels{/name}",
    "comments_url": "https://api.github.com/repos/beliaev-maksim/test-ci/issues/30/comments",
    "events_url": "https://api.github.com/repos/beliaev-maksim/test-ci/issues/30/events",
    "html_url": "https://github.com/beliaev-maksim/test-ci/issues/30",
    "id": 2734056389,
    "node_id": "I_kwDOMMYch86i9mPF",
    "number": 30,
    "title": "istio-beacon has no way to be integrated into a service mesh, thus cannot obtain AuthorizationPolicies or put itself on the mesh",
    "user": {
      "login": "ca-scribner",
      "id": 48125859,
      "node_id": "MDQ6VXNlcjQ4MTI1ODU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/48125859?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ca-scribner",
      "html_url": "https://github.com/ca-scribner",
      "followers_url": "https://api.github.com/users/ca-scribner/followers",
      "following_url": "https://api.github.com/users/ca-scribner/following{/other_user}",
      "gists_url": "https://api.github.com/users/ca-scribner/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ca-scribner/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ca-scribner/subscriptions",
      "organizations_url": "https://api.github.com/users/ca-scribner/orgs",
      "repos_url": "https://api.github.com/users/ca-scribner/repos",
      "events_url": "https://api.github.com/users/ca-scribner/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ca-scribner/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "labels": [
      {
        "id": 5157325446,
        "node_id": "LA_kwDOI-HsRM8AAAABM2aKhg",
        "url": "https://api.github.com/repos/beliaev-maksim/test-ci/labels/bug",
        "name": "bug",
        "color": "d73a4a",
        "default": true,
        "description": "Something isn't working"
      }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [

    ],
    "milestone": null,
    "comments": 0,
    "created_at": "2024-12-11T21:23:17Z",
    "updated_at": "2024-12-11T21:23:17Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "### Bug Description\n\nistio-beacon does not implement the **requirer** side of the service-mesh (and if it did, can it relate to itself to be its own provider?), and thus has no way of:\r\n1. obtaining AuthorizationPolicies to allow prometheus to scrape it\r\n2. put itself on the mesh, other than through `model-on-mesh=True`\r\n\r\nIn particular, (1) means that if istio-beacon is deployed with `model-on-mesh=True` and istio-k8s is deployed with `auto-allow-waypoint-policy=true` then:\r\n* the waypoint deployed by istio-beacon will be a waypoint for the istio-beacon charm\r\n* because the istio-beacon charm has a waypoint, it will implicitly get a `waypoint->istio-beacon charm` ztunnel authorization policy\r\n* because it has the above policy, it now rejects all other traffic that does not have a policy\r\n\r\nThis means that beacon effectively blocks its own COS integrations. \r\n\r\nOther note:\r\n* however we solve this, we should check whether prometheus can scrape from both on- and off-mesh.  I think we've checked this before, but I don't remember for sure\n\n### To Reproduce\n\n```\r\njuju add-model istio-system\r\njuju deploy istio-k8s --channel edge --trust  --config auto-allow-waypoint-policy=true\r\n\r\njuju add-model bookinfo\r\njuju deploy istio-beacon-k8s -m bookinfo --trust --channel edge --config model-on-mesh=True \r\n\r\njuju add-model prometheus\r\njuju switch prometheus\r\njuju deploy prometheus-k8s prometheus --trust\r\njuju offer prometheus:metrics-endpoint\r\n\r\njuju consume -m bookinfo admin/prometheus.prometheus\r\njuju relate -m bookinfo istio-beacon-k8s prometheus\r\n```\r\n\r\nthen watch the ztunnel logs, where we'll see prometheus's scrapes of beacon are rejected \n\n### Environment\n\nistio 1.24.0\n\n### Relevant log output\n\n```shell\n2024-12-11T20:49:42.787334Z    error    access    connection complete    src.addr=192.168.0.31:26867 dst.addr=10.1.253.201:17071 dst.service=\"modeloperator.bookinfo.svc.cluster.local\" dst.workload=\"modeloperator-6c4f5544cb-xpplf\" dst.namespace=\"bookinfo\" direction=\"inbound\" bytes_sent=0 bytes_recv=0 duration=\"0ms\" error=\"connection closed due to policy rejection: allow policies exist, but none allowed\"\n```\n\n\n### Additional context\n\n_No response_",
    "reactions": {
      "url": "https://api.github.com/repos/beliaev-maksim/test-ci/issues/30/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/beliaev-maksim/test-ci/issues/30/timeline",
    "performed_via_github_app": null,
    "state_reason": null
  },
  "label": {
    "id": 7538030605,
    "node_id": "LA_kwDOMMYch88AAAABwU1jBQ",
    "url": "https://api.github.com/repos/beliaev-maksim/test-ci/labels/Status:%20Triage",
    "name": "Status: Triage",
    "color": "d15130",
    "default": false,
    "description": ""
  },
  "repository": {
    "id": 818289799,
    "node_id": "R_kgDOMMYchw",
    "name": "test-ci",
    "full_name": "beliaev-maksim/test-ci",
    "private": false,
    "owner": {
      "login": "beliaev-maksim",
      "id": 53057619,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjUzMDU3NjE5",
      "avatar_url": "https://avatars.githubusercontent.com/u/53057619?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/beliaev-maksim",
      "html_url": "https://github.com/beliaev-maksim",
      "followers_url": "https://api.github.com/users/beliaev-maksim/followers",
      "following_url": "https://api.github.com/users/beliaev-maksim/following{/other_user}",
      "gists_url": "https://api.github.com/users/beliaev-maksim/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/beliaev-maksim/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/beliaev-maksim/subscriptions",
      "organizations_url": "https://api.github.com/users/beliaev-maksim/orgs",
      "repos_url": "https://api.github.com/users/beliaev-maksim/repos",
      "events_url": "https://api.github.com/users/beliaev-maksim/events{/privacy}",
      "received_events_url": "https://api.github.com/users/beliaev-maksim/received_events",
      "type": "Organization",
      "user_view_type": "public",
      "site_admin": false
    },
    "html_url": "https://github.com/beliaev-maksim/test-ci",
    "description": null,
    "fork": false,
    "url": "https://api.github.com/repos/beliaev-maksim/test-ci",
    "forks_url": "https://api.github.com/repos/beliaev-maksim/test-ci/forks",
    "keys_url": "https://api.github.com/repos/beliaev-maksim/test-ci/keys{/key_id}",
    "collaborators_url": "https://api.github.com/repos/beliaev-maksim/test-ci/collaborators{/collaborator}",
    "teams_url": "https://api.github.com/repos/beliaev-maksim/test-ci/teams",
    "hooks_url": "https://api.github.com/repos/beliaev-maksim/test-ci/hooks",
    "issue_events_url": "https://api.github.com/repos/beliaev-maksim/test-ci/issues/events{/number}",
    "events_url": "https://api.github.com/repos/beliaev-maksim/test-ci/events",
    "assignees_url": "https://api.github.com/repos/beliaev-maksim/test-ci/assignees{/user}",
    "branches_url": "https://api.github.com/repos/beliaev-maksim/test-ci/branches{/branch}",
    "tags_url": "https://api.github.com/repos/beliaev-maksim/test-ci/tags",
    "blobs_url": "https://api.github.com/repos/beliaev-maksim/test-ci/git/blobs{/sha}",
    "git_tags_url": "https://api.github.com/repos/beliaev-maksim/test-ci/git/tags{/sha}",
    "git_refs_url": "https://api.github.com/repos/beliaev-maksim/test-ci/git/refs{/sha}",
    "trees_url": "https://api.github.com/repos/beliaev-maksim/test-ci/git/trees{/sha}",
    "statuses_url": "https://api.github.com/repos/beliaev-maksim/test-ci/statuses/{sha}",
    "languages_url": "https://api.github.com/repos/beliaev-maksim/test-ci/languages",
    "stargazers_url": "https://api.github.com/repos/beliaev-maksim/test-ci/stargazers",
    "contributors_url": "https://api.github.com/repos/beliaev-maksim/test-ci/contributors",
    "subscribers_url": "https://api.github.com/repos/beliaev-maksim/test-ci/subscribers",
    "subscription_url": "https://api.github.com/repos/beliaev-maksim/test-ci/subscription",
    "commits_url": "https://api.github.com/repos/beliaev-maksim/test-ci/commits{/sha}",
    "git_commits_url": "https://api.github.com/repos/beliaev-maksim/test-ci/git/commits{/sha}",
    "comments_url": "https://api.github.com/repos/beliaev-maksim/test-ci/comments{/number}",
    "issue_comment_url": "https://api.github.com/repos/beliaev-maksim/test-ci/issues/comments{/number}",
    "contents_url": "https://api.github.com/repos/beliaev-maksim/test-ci/contents/{+path}",
    "compare_url": "https://api.github.com/repos/beliaev-maksim/test-ci/compare/{base}...{head}",
    "merges_url": "https://api.github.com/repos/beliaev-maksim/test-ci/merges",
    "archive_url": "https://api.github.com/repos/beliaev-maksim/test-ci/{archive_format}{/ref}",
    "downloads_url": "https://api.github.com/repos/beliaev-maksim/test-ci/downloads",
    "issues_url": "https://api.github.com/repos/beliaev-maksim/test-ci/issues{/number}",
    "pulls_url": "https://api.github.com/repos/beliaev-maksim/test-ci/pulls{/number}",
    "milestones_url": "https://api.github.com/repos/beliaev-maksim/test-ci/milestones{/number}",
    "notifications_url": "https://api.github.com/repos/beliaev-maksim/test-ci/notifications{?since,all,participating}",
    "labels_url": "https://api.github.com/repos/beliaev-maksim/test-ci/labels{/name}",
    "releases_url": "https://api.github.com/repos/beliaev-maksim/test-ci/releases{/id}",
    "deployments_url": "https://api.github.com/repos/beliaev-maksim/test-ci/deployments",
    "created_at": "2024-06-21T14:09:06Z",
    "updated_at": "2024-12-03T15:24:20Z",
    "pushed_at": "2024-12-03T15:20:49Z",
    "git_url": "git://github.com/beliaev-maksim/test-ci.git",
    "ssh_url": "git@github.com:beliaev-maksim/test-ci.git",
    "clone_url": "https://github.com/beliaev-maksim/test-ci.git",
    "svn_url": "https://github.com/beliaev-maksim/test-ci",
    "homepage": "https://charmhub.io/istio-beacon-k8s",
    "size": 149,
    "stargazers_count": 0,
    "watchers_count": 0,
    "language": "Python",
    "has_issues": true,
    "has_projects": false,
    "has_downloads": true,
    "has_wiki": false,
    "has_pages": false,
    "has_discussions": false,
    "forks_count": 0,
    "mirror_url": null,
    "archived": false,
    "disabled": false,
    "open_issues_count": 14,
    "license": {
      "key": "apache-2.0",
      "name": "Apache License 2.0",
      "spdx_id": "Apache-2.0",
      "url": "https://api.github.com/licenses/apache-2.0",
      "node_id": "MDc6TGljZW5zZTI="
    },
    "allow_forking": true,
    "is_template": false,
    "web_commit_signoff_required": true,
    "topics": [

    ],
    "visibility": "public",
    "forks": 0,
    "open_issues": 14,
    "watchers": 0,
    "default_branch": "main",
    "custom_properties": {

    }
  },
  "organization": {
    "login": "beliaev-maksim",
    "id": 53057619,
    "node_id": "MDEyOk9yZ2FuaXphdGlvbjUzMDU3NjE5",
    "url": "https://api.github.com/orgs/beliaev-maksim",
    "repos_url": "https://api.github.com/orgs/beliaev-maksim/repos",
    "events_url": "https://api.github.com/orgs/beliaev-maksim/events",
    "hooks_url": "https://api.github.com/orgs/beliaev-maksim/hooks",
    "issues_url": "https://api.github.com/orgs/beliaev-maksim/issues",
    "members_url": "https://api.github.com/orgs/beliaev-maksim/members{/member}",
    "public_members_url": "https://api.github.com/orgs/beliaev-maksim/public_members{/member}",
    "avatar_url": "https://avatars.githubusercontent.com/u/53057619?v=4",
    "description": ""
  },
  "enterprise": {
    "id": 103375,
    "slug": "beliaev-maksim",
    "name": "beliaev-maksim",
    "node_id": "E_kgDOAAGTzw",
    "avatar_url": "https://avatars.githubusercontent.com/b/103375?v=4",
    "description": null,
    "website_url": null,
    "html_url": "https://github.com/enterprises/beliaev-maksim",
    "created_at": "2023-12-11T08:42:36Z",
    "updated_at": "2024-10-21T08:16:43Z"
  },
  "sender": {
    "login": "ca-scribner",
    "id": 48125859,
    "node_id": "MDQ6VXNlcjQ4MTI1ODU5",
    "avatar_url": "https://avatars.githubusercontent.com/u/48125859?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ca-scribner",
    "html_url": "https://github.com/ca-scribner",
    "followers_url": "https://api.github.com/users/ca-scribner/followers",
    "following_url": "https://api.github.com/users/ca-scribner/following{/other_user}",
    "gists_url": "https://api.github.com/users/ca-scribner/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ca-scribner/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ca-scribner/subscriptions",
    "organizations_url": "https://api.github.com/users/ca-scribner/orgs",
    "repos_url": "https://api.github.com/users/ca-scribner/repos",
    "events_url": "https://api.github.com/users/ca-scribner/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ca-scribner/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "installation": {
    "id": 37898057,
    "node_id": "MDIzOkludGVncmF0aW9uSW5zdGFsbGF0aW9uMzc4OTgwNTc="
  }
}